<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Oper Analyst ‚Äî Doc Chat</title>
    <link rel="stylesheet" href="/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  </head>
  <body>
    <div class="app">
      <!-- Top Nav -->
      <header class="topnav">
        <div class="brand">
          <svg class="logo" viewBox="0 0 32 32" aria-hidden="true"><circle cx="16" cy="16" r="14" />
            <path d="M10 17c0-3.866 3.134-7 7-7h5v5c0 3.866-3.134 7-7 7h-5v-5z" />
          </svg>
          <div class="brand-text">
            <div class="title">Oper Analyst</div>
            <div class="subtitle">Doc Chat</div>
          </div>
        </div>
        <div class="top-actions">
          <div class="kbd-hint">‚åò/ to focus chat</div>
          <button class="btn ghost" id="themeToggle" title="Toggle theme">‚òæ</button>
          <div class="avatar">AN</div>
        </div>
      </header>

      <!-- Sub header with chat -->
      <section class="subheader">
        <div class="chat-input">
          <div class="prefix">
            <svg width="18" height="18" viewBox="0 0 24 24"><path d="M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z"/></svg>
          </div>
          <input id="chatInput" placeholder="Ask: show me income for May ¬∑ show the client‚Äôs name in all docs ¬∑ find IBAN" />
          <button class="btn primary" id="sendBtn">Search</button>
        </div>
        <div class="chips" id="suggestions">
          <button class="chip">show me income for May</button>
          <button class="chip">show the client‚Äôs name in all docs</button>
          <button class="chip">find IBAN</button>
          <button class="chip">address</button>
        </div>
      </section>

      <!-- Content -->
      <main class="layout">
        <!-- Sidebar: Documents -->
        <aside class="sidebar">
          <div class="side-header">
            <div class="side-title">Documents</div>
            <button class="btn small primary" id="uploadBtn" aria-label="Upload PDFs">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 16V4m0 0l-4 4m4-4l4 4M4 16v4h16v-4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>Upload</span>
            </button>
          </div>
          <div class="search-inline">
            <input id="docSearch" placeholder="Filter docs‚Ä¶" />
          </div>
          <ul id="docList" class="doc-list"></ul>
          <div class="empty" id="emptyDocs">
            <div class="empty-icon">üìÑ</div>
            <div class="empty-title">No documents yet</div>
            <div class="empty-text">Upload PDFs to start reviewing.</div>
          </div>
        </aside>

        <!-- Center: PDF Viewer -->
        <section class="workspace">
          <div class="toolbar">
            <div class="intent" id="intentView">
              <span class="badge">Intent</span>
              <span class="intent-text">‚Äî</span>
            </div>
            <div class="spacer"></div>
            <div class="nav">
              <button class="btn ghost" id="prevHit" disabled>
                <span class="icon">‚óÄ</span><span class="hide-sm">Prev</span>
              </button>
              <div id="hitStatus" class="muted">No matches</div>
              <button class="btn ghost" id="nextHit" disabled>
                <span class="hide-sm">Next</span><span class="icon">‚ñ∂</span>
              </button>
              <button class="btn ghost" id="clearResults" title="Clear results">Clear</button>
              <button class="btn primary" id="requestBtn" title="Request re-upload">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M4 6.5A2.5 2.5 0 0 1 6.5 4h11A2.5 2.5 0 0 1 20 6.5v11a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 4 17.5z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round" />
                  <path d="m5.5 7 6.5 4.5L18.5 7" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                  <path d="M8 15h8m-6 3h4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
                </svg>
                <span>Request re-upload</span>
              </button>
            </div>
          </div>
          <div id="pdfContainer" class="pdf-container">
            <div class="placeholder">
              <div class="ph-title">Open a document</div>
              <div class="ph-text">Your highlights will appear directly on the page.</div>
            </div>
          </div>
        </section>

        <!-- Right drawer: Matches -->
        <aside class="drawer">
          <div class="drawer-header">
            <div class="drawer-title">Matches</div>
            <div class="drawer-sub" id="matchesMeta">‚Äî</div>
          </div>
          <ol class="matches" id="matchesList"></ol>
          <div class="empty" id="emptyMatches">
            <div class="empty-icon">üîç</div>
            <div class="empty-title">No matches</div>
            <div class="empty-text">Ask a question to search across documents.</div>
          </div>
        </aside>
      </main>

      <!-- Toasts -->
      <div class="toasts" id="toasts"></div>

      <footer class="footer">
        <span>¬© 2025 Oper ‚Äî Analyst Tools</span>
        <span class="muted">PoC build ‚Ä¢ Python ¬∑ FastAPI ¬∑ PDF.js</span>
      </footer>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept="application/pdf" multiple style="display:none" />

    <!-- Front-end config: default to offline-friendly fallbacks (no CDN access required) -->
    <script>
      window.DocChaseConfig = window.DocChaseConfig || {};
      window.DocChaseConfig.pdf = Object.assign({ enableCdn: false }, window.DocChaseConfig.pdf || {});
      window.DocChaseConfig.transformers = Object.assign({ enableCdn: false }, window.DocChaseConfig.transformers || {});
    </script>

    <!-- In-browser LLM (no external API) -->
    <script type="module" src="/llm.js?v=1"></script>

    <!-- App -->
    <script src="/app.js?v=5"></script>

    <!-- Re-upload Modal -->
    <div class="modal hidden" id="reuploadModal" aria-hidden="true">
      <div class="modal-card">
        <button class="modal-close" id="closeModal" aria-label="Close re-upload request">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="m8 8 8 8m0-8-8 8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" /></svg>
        </button>
        <div class="modal-head">
          <div class="modal-icon" aria-hidden="true">
            <svg viewBox="0 0 48 48">
              <rect x="6" y="10" width="36" height="28" rx="6" fill="none" stroke="currentColor" stroke-width="2" />
              <path d="m10 14 14 11 14-11" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M16 32h16m-12 6h8" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
          </div>
          <div class="modal-titles">
            <div class="title">Request re-upload</div>
            <div class="subtitle">We‚Äôve pre-filled the borrower details. Make any tweaks, then have the AI draft your email.</div>
          </div>
          <div class="status" id="llmStatus">LLM: loading‚Ä¶</div>
        </div>

        <div class="modal-body">
          <section class="panel form-panel">
            <div class="panel-head">
              <h3>Borrower details</h3>
              <span class="pill">Prefilled from context</span>
            </div>
            <div class="field-grid">
              <div class="field">
                <label for="r_name">Borrower name</label>
                <input id="r_name" placeholder="Jane Doe" />
              </div>
              <div class="field">
                <label for="r_email">Borrower email</label>
                <input id="r_email" placeholder="jane@example.com" />
              </div>
            </div>
            <div class="field">
              <label for="r_missing">Missing items</label>
              <textarea id="r_missing" rows="5" placeholder="May payslip&#10;Bank statement (June, all pages)"></textarea>
              <div class="field-hint">One item per line. We include what the borrower still owes.</div>
            </div>
            <div class="field">
              <label for="r_issues">Issues / corrections</label>
              <textarea id="r_issues" rows="4" placeholder="ID photo is blurry&#10;Address differs from application"></textarea>
            </div>
            <div class="field-grid trio">
              <div class="field">
                <label for="r_due">Due date</label>
                <input id="r_due" placeholder="YYYY-MM-DD" />
              </div>
              <div class="field">
                <label for="r_lang">Language</label>
                <select id="r_lang">
                  <option value="English" selected>English</option>
                  <option>French</option><option>Dutch</option><option>German</option>
                </select>
              </div>
              <div class="field">
                <label for="r_tone">Tone</label>
                <select id="r_tone">
                  <option value="friendly" selected>friendly</option>
                  <option>formal</option><option>assertive</option>
                </select>
              </div>
            </div>
          </section>

          <section class="panel preview-panel">
            <div class="preview-head">
              <div>
                <h3>Email draft</h3>
                <p>Generate with the LLM or fine-tune manually before sending.</p>
              </div>
              <button class="btn" id="draftBtn">Generate with AI</button>
            </div>
            <div class="field">
              <div class="field-top">
                <label for="out_subject">Subject</label>
                <button class="icon-button" id="copySub" type="button" aria-label="Copy subject">
                  <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9 9V5.5A1.5 1.5 0 0 1 10.5 4h8A1.5 1.5 0 0 1 20 5.5v8A1.5 1.5 0 0 1 18.5 15H15" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" /><rect x="4" y="9" width="11" height="11" rx="2" fill="none" stroke="currentColor" stroke-width="1.6" /></svg>
                </button>
              </div>
              <input id="out_subject" />
            </div>
            <div class="field">
              <div class="field-top">
                <label for="out_body">Body</label>
                <button class="icon-button" id="copyBody" type="button" aria-label="Copy body">
                  <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5h10.5A1.5 1.5 0 0 1 20 6.5V17" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" /><rect x="4" y="7" width="12" height="13" rx="2" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round" /></svg>
                </button>
              </div>
              <textarea id="out_body" rows="10"></textarea>
            </div>
          </section>
        </div>

        <div class="send-bar">
          <div class="send-meta">
            <div class="send-icon" aria-hidden="true">‚úâÔ∏è</div>
            <div>
              <div class="send-title">Ready to reach out?</div>
              <div class="send-text">Review the draft, then send it with your default mail app.</div>
            </div>
          </div>
          <div class="send-actions">
            <button class="btn primary" type="button" id="openMail">Send email</button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
